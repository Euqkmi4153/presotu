<!-- OK，JavaScript経由での外部通信(fetch/XMLHttpRequest/動的スクリプト生成)に対するCSP挙動とCORS挙動の確認 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
</head>

<body>
  <h1>aaa</h1>
</body>

<!-- defer のままでOK -->
<script defer>
  const a = 1;

  // --- 同一オリジンCORSプロキシ経由に変更（/_cors?u=...）---
  // XHR: not-example.com を直接叩かずサーバ側フェッチへ
  (function () {
    const url = "https://not-example.com/";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/_cors?u=" + encodeURIComponent(url));
    xhr.onload = () => console.log("[XHR ok]", url, xhr.status);
    xhr.onerror = () => console.warn("[XHR error]", url);
    xhr.send();
  })();

  (async () => {
    // YouTube TOPはHTMLを返すので .text() で扱う（.json()は失敗する）
    const yt = await fetch("/_cors?u=" + encodeURIComponent("https://www.youtube.com/"));
    console.log("[fetch youtube] status", yt.status);
    const ytText = await yt.text();
    console.log("[fetch youtube] length", ytText.length);

    // はてなhotentryもHTML。JSON APIにしたいならAPIのURLを指定すること
    const hatena = await fetch(
      "/_cors?u=" + encodeURIComponent("https://b.hatena.ne.jp/hotentry/it")
    );
    console.log("[fetch hatena] status", hatena.status);
    const hatenaText = await hatena.text();
    console.log("[fetch hatena] length", hatenaText.length);
  })().catch((e) => console.warn("fetch error", e));

  // --- 動的scriptは同一オリジンで配布（混在コンテンツ回避）---
  (function () {
    var s = document.createElement("script");
    // 旧: s.src = "http://localhost:8080/index.js";
    // 新: http.js が /index.js を同一オリジンで返す
    s.src = "/index.js";
    document.querySelector("head").appendChild(s);
  })();
</script>

</html>